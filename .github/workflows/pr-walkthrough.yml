name: PR Code Walkthrough

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ master, main ]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  advanced-walkthrough:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'adopt'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install analysis tools
        run: |
          # å®‰è£…å›¾è¡¨ç”Ÿæˆå·¥å…·
          npm install -g @mermaid-js/mermaid-cli
          npm install -g dependency-cruiser
          
          # å®‰è£…Javaä»£ç åˆ†æå·¥å…·
          wget -O /tmp/checkstyle.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar

      - name: Generate comprehensive file analysis
        run: |
          mkdir -p walkthrough-report
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          git diff --name-only origin/main...HEAD > walkthrough-report/changed-files.txt
          git diff --stat origin/main...HEAD > walkthrough-report/diff-stats.txt
          
          # åˆ›å»ºè¯¦ç»†çš„æ–‡ä»¶èµ°æŸ¥æŠ¥å‘Š
          cat > walkthrough-report/detailed-walkthrough.md << 'EOF'
          # ğŸ” è¯¦ç»†ä»£ç èµ°æŸ¥æŠ¥å‘Š
          
          ## ğŸ“ˆ å˜æ›´ç»Ÿè®¡æ¦‚è§ˆ
          EOF
          
          # æ·»åŠ å·®å¼‚ç»Ÿè®¡
          echo '```' >> walkthrough-report/detailed-walkthrough.md
          cat walkthrough-report/diff-stats.txt >> walkthrough-report/detailed-walkthrough.md
          echo '```' >> walkthrough-report/detailed-walkthrough.md
          echo '' >> walkthrough-report/detailed-walkthrough.md
          
          # åˆ†ææ¯ä¸ªå˜æ›´æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯
          echo '## ğŸ“‹ æ–‡ä»¶è¯¦ç»†åˆ†æ' >> walkthrough-report/detailed-walkthrough.md
          echo '' >> walkthrough-report/detailed-walkthrough.md
          
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "### ğŸ“„ \`$file\`" >> walkthrough-report/detailed-walkthrough.md
              echo '' >> walkthrough-report/detailed-walkthrough.md
          
              # æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
              size=$(wc -c < "$file" 2>/dev/null || echo "0")
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "- **æ–‡ä»¶å¤§å°**: ${size} bytes" >> walkthrough-report/detailed-walkthrough.md
              echo "- **è¡Œæ•°**: ${lines} è¡Œ" >> walkthrough-report/detailed-walkthrough.md
          
              # è·å–å˜æ›´ç»Ÿè®¡
              diff_stats=$(git diff --numstat origin/main...HEAD -- "$file")
              if [ -n "$diff_stats" ]; then
                additions=$(echo "$diff_stats" | cut -f1)
                deletions=$(echo "$diff_stats" | cut -f2)
                echo "- **æ–°å¢è¡Œæ•°**: ${additions}" >> walkthrough-report/detailed-walkthrough.md
                echo "- **åˆ é™¤è¡Œæ•°**: ${deletions}" >> walkthrough-report/detailed-walkthrough.md
              fi
          
              # Javaæ–‡ä»¶ç‰¹æ®Šåˆ†æ
              if [[ $file == *.java ]]; then
                classes=$(grep -c "^[[:space:]]*\(public\|private\|protected\).*class" "$file" 2>/dev/null || echo "0")
                methods=$(grep -c "^\s*\(public\|private\|protected\).*\s\+\w\+\s*(" "$file" 2>/dev/null || echo "0")
                imports=$(grep -c "^import" "$file" 2>/dev/null || echo "0")
          
                echo "- **ç±»æ•°é‡**: ${classes}" >> walkthrough-report/detailed-walkthrough.md
                echo "- **æ–¹æ³•æ•°é‡**: ${methods}" >> walkthrough-report/detailed-walkthrough.md
                echo "- **å¯¼å…¥æ•°é‡**: ${imports}" >> walkthrough-report/detailed-walkthrough.md
          
                # è¿è¡Œcheckstyleæ£€æŸ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if [ -f "/tmp/checkstyle.jar" ]; then
                  checkstyle_result=$(java -jar /tmp/checkstyle.jar -c google_checks.xml "$file" 2>/dev/null || echo "æ— æ³•è¿è¡Œcheckstyleæ£€æŸ¥")
                  if [ "$checkstyle_result" != "æ— æ³•è¿è¡Œcheckstyleæ£€æŸ¥" ]; then
                    violations=$(echo "$checkstyle_result" | grep -c "\[ERROR\]" || echo "0")
                    echo "- **ä»£ç é£æ ¼é—®é¢˜**: ${violations} ä¸ª" >> walkthrough-report/detailed-walkthrough.md
                  fi
                fi
              fi
          
              echo '' >> walkthrough-report/detailed-walkthrough.md
          
              # æ˜¾ç¤ºå…³é”®å˜æ›´ç‰‡æ®µ
              echo '#### ğŸ”„ ä¸»è¦å˜æ›´å†…å®¹:' >> walkthrough-report/detailed-walkthrough.md
              echo '```diff' >> walkthrough-report/detailed-walkthrough.md
              git diff origin/main...HEAD -- "$file" | head -50 >> walkthrough-report/detailed-walkthrough.md
              echo '```' >> walkthrough-report/detailed-walkthrough.md
              echo '' >> walkthrough-report/detailed-walkthrough.md
              echo '---' >> walkthrough-report/detailed-walkthrough.md
              echo '' >> walkthrough-report/detailed-walkthrough.md
            fi
          done < walkthrough-report/changed-files.txt

      - name: Generate project dependency diagrams
        run: |
          # ç”ŸæˆMavenæ¨¡å—ä¾èµ–å›¾
          cat > walkthrough-report/module-dependency.md << 'EOF'
          ## ğŸ—ï¸ æ¨¡å—ä¾èµ–å…³ç³»å›¾
          
          ```mermaid
          graph TB
              subgraph "FastExcel æ¨¡å—ç»“æ„"
                  core["fastexcel-core<br/>ğŸ”§ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—"]
                  main["fastexcel<br/>ğŸ“¦ ä¸»æ¨¡å—"]
                  support["fastexcel-support<br/>ğŸ› ï¸ æ”¯æŒæ¨¡å—"]
                  test["fastexcel-test<br/>ğŸ§ª æµ‹è¯•æ¨¡å—"]
              end
          
              subgraph "æ¨¡å—ä¾èµ–å…³ç³»"
                  core --> main
                  support --> main
                  test --> core
                  test --> support
              end
          
              subgraph "å¤–éƒ¨ä¾èµ–"
                  poi["Apache POI<br/>ğŸ“Š Excelå¤„ç†"]
                  slf4j["SLF4J<br/>ğŸ“ æ—¥å¿—æ¡†æ¶"]
                  junit["JUnit<br/>ğŸ§ª å•å…ƒæµ‹è¯•"]
              end
          
              poi --> core
              slf4j --> core
              junit --> test
          
              classDef coreModule fill:#e1f5fe,stroke:#01579b,stroke-width:2px
              classDef supportModule fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
              classDef testModule fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
              classDef external fill:#fff3e0,stroke:#e65100,stroke-width:2px
          
              class core coreModule
              class main,support supportModule
              class test testModule
              class poi,slf4j,junit external
          ```
          EOF
          
          # ç”Ÿæˆè¯¦ç»†çš„Mavenä¾èµ–æ ‘
          echo '' >> walkthrough-report/module-dependency.md
          echo '## ğŸ“‹ è¯¦ç»†ä¾èµ–æ ‘' >> walkthrough-report/module-dependency.md
          echo '' >> walkthrough-report/module-dependency.md
          echo '```' >> walkthrough-report/module-dependency.md
          ./mvnw dependency:tree -Dverbose=true >> walkthrough-report/module-dependency.md 2>/dev/null || echo "æ— æ³•ç”Ÿæˆä¾èµ–æ ‘" >> walkthrough-report/module-dependency.md
          echo '```' >> walkthrough-report/module-dependency.md

      - name: Generate security analysis
        run: |
          cat > walkthrough-report/security-analysis.md << 'EOF'
          ## ğŸ”’ å®‰å…¨æ€§åˆ†æ
          
          ### ğŸ“Š æ½œåœ¨å®‰å…¨é—®é¢˜æ£€æŸ¥
          EOF
          
          # æ£€æŸ¥å¸¸è§çš„å®‰å…¨é—®é¢˜æ¨¡å¼
          echo '' >> walkthrough-report/security-analysis.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
          sensitive_patterns=0
          if grep -r -E "(password|secret|key|token).*=" . --include="*.java" --include="*.xml" --include="*.yml" 2>/dev/null; then
            sensitive_patterns=$((sensitive_patterns + $(grep -r -E "(password|secret|key|token).*=" . --include="*.java" --include="*.xml" --include="*.yml" 2>/dev/null | wc -l)))
          fi
          
          echo "- **æ½œåœ¨æ•æ„Ÿä¿¡æ¯**: ${sensitive_patterns} å¤„" >> walkthrough-report/security-analysis.md
          
          # æ£€æŸ¥SQLæ³¨å…¥é£é™©
          sql_risks=$(grep -r -E "(Statement|executeQuery|executeUpdate).*\+" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **æ½œåœ¨SQLæ³¨å…¥é£é™©**: ${sql_risks} å¤„" >> walkthrough-report/security-analysis.md
          
          # æ£€æŸ¥æ–‡ä»¶æ“ä½œå®‰å…¨
          file_ops=$(grep -r -E "(File|FileInputStream|FileOutputStream|Path).*\+" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **æ–‡ä»¶æ“ä½œé£é™©**: ${file_ops} å¤„" >> walkthrough-report/security-analysis.md
          
          echo '' >> walkthrough-report/security-analysis.md
          echo '> âš ï¸ è¿™äº›æ£€æŸ¥æ˜¯åŸºäºæ¨¡å¼åŒ¹é…çš„ç®€å•åˆ†æï¼Œå¯èƒ½å­˜åœ¨è¯¯æŠ¥ã€‚å»ºè®®è¿›è¡Œäººå·¥å®¡æŸ¥ã€‚' >> walkthrough-report/security-analysis.md

      - name: Generate performance impact analysis
        run: |
          cat > walkthrough-report/performance-analysis.md << 'EOF'
          ## âš¡ æ€§èƒ½å½±å“åˆ†æ
          
          ### ğŸ“ˆ å¯èƒ½çš„æ€§èƒ½å½±å“ç‚¹
          EOF
          
          # æ£€æŸ¥å¾ªç¯åµŒå¥—
          nested_loops=$(grep -r -E "for.*for|while.*while|for.*while|while.*for" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **åµŒå¥—å¾ªç¯**: ${nested_loops} å¤„" >> walkthrough-report/performance-analysis.md
          
          # æ£€æŸ¥å­—ç¬¦ä¸²è¿æ¥
          string_concat=$(grep -r -E "\+.*\"|\"\s*\+" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **å­—ç¬¦ä¸²æ‹¼æ¥**: ${string_concat} å¤„" >> walkthrough-report/performance-analysis.md
          
          # æ£€æŸ¥é›†åˆæ“ä½œ
          collection_ops=$(grep -r -E "(ArrayList|HashMap|HashSet).*new" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **é›†åˆåˆ›å»º**: ${collection_ops} å¤„" >> walkthrough-report/performance-analysis.md
          
          # æ£€æŸ¥åŒæ­¥æ“ä½œ
          sync_ops=$(grep -r -E "(synchronized|ConcurrentHashMap|AtomicInteger)" . --include="*.java" 2>/dev/null | wc -l || echo "0")
          echo "- **åŒæ­¥æ“ä½œ**: ${sync_ops} å¤„" >> walkthrough-report/performance-analysis.md
          
          echo '' >> walkthrough-report/performance-analysis.md
          echo '### ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®' >> walkthrough-report/performance-analysis.md
          echo '- è€ƒè™‘ä½¿ç”¨StringBuilderä»£æ›¿å­—ç¬¦ä¸²æ‹¼æ¥' >> walkthrough-report/performance-analysis.md
          echo '- é¿å…ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º' >> walkthrough-report/performance-analysis.md
          echo '- ä¼˜åŒ–å¾ªç¯é€»è¾‘ï¼Œå‡å°‘åµŒå¥—å±‚æ•°' >> walkthrough-report/performance-analysis.md
          echo '- åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶' >> walkthrough-report/performance-analysis.md

      - name: Upload comprehensive analysis
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-walkthrough-${{ github.event.number }}
          path: walkthrough-report/
          retention-days: 30

      - name: Post comprehensive walkthrough comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '# ğŸ“Š ç»¼åˆä»£ç èµ°æŸ¥æŠ¥å‘Š\n\n';
            comment += '> ğŸ¤– **è‡ªåŠ¨ç”Ÿæˆçš„è¯¦ç»†åˆ†ææŠ¥å‘Š**\n\n';
            
            // è¯»å–å„éƒ¨åˆ†åˆ†æç»“æœ
            const sections = [
              { file: 'detailed-walkthrough.md', title: 'æ–‡ä»¶è¯¦ç»†åˆ†æ' },
              { file: 'module-dependency.md', title: 'æ¨¡å—ä¾èµ–åˆ†æ' },
              { file: 'security-analysis.md', title: 'å®‰å…¨æ€§åˆ†æ' },
              { file: 'performance-analysis.md', title: 'æ€§èƒ½åˆ†æ' }
            ];
            
            for (const section of sections) {
              try {
                const content = fs.readFileSync(`walkthrough-report/${section.file}`, 'utf8');
                comment += content + '\n\n';
              } catch (e) {
                comment += `## âŒ ${section.title}\næ— æ³•ç”Ÿæˆ ${section.title} - è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—\n\n`;
              }
            }
            
            comment += '---\n';
            comment += '## ğŸ“ å®Œæ•´æŠ¥å‘Šä¸‹è½½\n';
            comment += `> ğŸ“‹ å®Œæ•´çš„èµ°æŸ¥æŠ¥å‘Šå·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰© \`comprehensive-walkthrough-${context.issue.number}\`\n`;
            comment += '> ğŸ” å»ºè®®reviewersé‡ç‚¹å…³æ³¨æ ‡è®°ä¸ºé«˜é£é™©çš„å˜æ›´\n';
            comment += '> ğŸ’¡ è¿™æ˜¯è‡ªåŠ¨åŒ–åˆ†æï¼Œæœ€ç»ˆçš„ä»£ç è´¨é‡åˆ¤æ–­ä»éœ€äººå·¥å®¡æŸ¥\n\n';
            comment += '*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ' + new Date().toISOString() + '*';
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç»¼åˆæŠ¥å‘Šè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ç»¼åˆä»£ç èµ°æŸ¥æŠ¥å‘Š')
            );
            
            if (existingComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
