name: CI Copilot Failure Prompt

on:
  workflow_run:
    # IMPORTANT: list the workflows you want to monitor for completion
    # Replace the example names below with your actual workflow names.
    workflows:
      - CI
      - Build
      - Test
    types: [completed]

permissions:
  actions: read
  contents: read
  pull-requests: write
  issues: write

jobs:
  prompt:
    if: >
      github.event.workflow_run.conclusion != 'success' &&
      github.event.workflow_run.name != 'CI Copilot Failure Prompt'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Post PR/Issue comment with Copilot-ready prompt (links only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          # JOB_ID/JOB_NAME not available on workflow_run; Java will auto-pick first failed job
          REPO: ${{ github.repository }}
          API_URL: ${{ github.api_url }}
          SERVER_URL: ${{ github.server_url }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
        run: |
          java scripts/CiCopilotPrompt.java